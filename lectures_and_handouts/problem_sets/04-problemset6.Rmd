# Problem set 6

## Questions
1. Using the tempo_simu.R file, 
    a. Try with N of 4 million -- does it still work? What happens?
    b. Try with a shift function that goes up and down. Are the adjusted counts ever LESS than the observed counts? If so, when?   
    c. If the cumulative shift was Rt = a + 0.1*t, what would be a formula for tempo-adjusted counts of births? Sketch the 4 panels without the computer and then check to see if you're right.
2. Calculate the age profile of fertility change predicted by the BongaartsFeeney model by taking time derivatives of the log schedules. You will end up with three terms. Describe each of these in words.  
3. Use simulation based on tempo simu.R to check your answer.  
4. Is there a diagnostic plot that you could do to compare observed agespecific changes to those predicted by the BF model? Hint: use normalized schedules that sum to 1.0  
5. Use this diagnostic plot to all-order fertility change during the Great Recession.  
6. Use this diagnostic plot to 1st, 2nd, and 3rd births.  
7. Fit the two-part normal mixture model to fertility from another country based on what looks interesting in the Burkimsher paper. (E.g., Canada, Portugal, or the Netherlands). I recommend doing this for 1 year, but once you get your code running, you could iterate over years. Use graphs to discuss the goodness of fit. And if you do more than 1 year, discuss whether the time trends in the parameters make substantive sense)

## Solutions
1. Using the tempo_simu.R file, 
    a. Try with N of 4 million -- does it still work? What happens?
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(data.table)
source("functions/utility_functions.R")
source("functions/tempo_functions.R")

million = 10^6
thousand = 10^3
N <-  4 * million
year.vec <- 1990:2020

#######################################
## simulate originally timed births  ##
#######################################

## we'll assume normal with age and uniform with time
x <- rnorm(N, mean = 30, sd = 4)
t <- runif(N, min = min(year.vec), max(year.vec)+1)
dt <- data.table(x, t)

#########################
## shifting the births ##
#########################

## we'll assume a continuous S-shaped cumulative shift
shift.t <- 2*plogis(seq(-5, 5, length.out = length(year.vec)))


plot(year.vec, shift.t, type = "o",
     main = "Cumulative shifts")



## include shifts as a column
Rt <- approx(x = year.vec, y = shift.t, xout = t)$y
dt[, Rt := approx(x = year.vec, y = shift.t, xout = t)$y]
## calculate shifted times and ages of births
dt[, t.obs := t + Rt]
dt[, x.obs := x + Rt]
## retain only the original time window (for convenience)
dt <- dt[floor(t.obs) %in% year.vec]


##########################################
## observed births counts and mean ages ##
##########################################

out <- dt[, .(Bt = .N,                   ## count the events
              mut = mean(x.obs)),      ## get mean age
          by = .(year = floor(t.obs))] ## by whole years
out <- out[order(year)]

############################################
## change in mean age and adjusted counts ##
############################################

out[, rt.hat := center.diff(mut, end.fill = T)]
out[, Rt.hat := cumsum(rt.hat)]
out[, Bt.adj := Bt / (1 - rt.hat)]


## function version of tabulating and plotting

tempo_simu_plot_fun <- function(dt)
{

    ## requires x.obs and t.obs and
    ## (optionally) t, the original unshifted birth times

##########################################
## observed births counts and mean ages ##
##########################################

out <- dt[, .(Bt = .N,                   ## count the events
              mut = mean(x.obs)),      ## get mean age
          by = .(year = floor(t.obs))] ## by whole years
out <- out[order(year)]

############################################
## change in mean age and adjusted counts ##
############################################

out[, rt.hat := center.diff(mut, end.fill = T)]
out[, Rt.hat := cumsum(rt.hat)]
out[, Bt.adj := Bt / (1 - rt.hat)]


######################
## plot the results ##
######################

par(mfrow = c(2,2))
out[, plot(year, Bt, ylim = c(.8, 1.2) * range(Bt),
           main = "Observed Births")]
out[, plot(year, mut,
           main = "Mean age of birth")]
out[, plot(year, center.diff(mut),
           main = "Change in mean age of birth")]
## observed, adjusted, and original births
Bt.orig.vec <- dt[, table(floor(t))]
out[, plot(year, Bt, ylim = c(.8, 1.5) * range(Bt),
           main = "Observed and Adjusted Births")]
out[, lines(year, Bt.adj, col = "red")]
points(names(Bt.orig.vec), Bt.orig.vec, col = "grey")
legend("top", c("observed", "adjusted", "original"),
       pch = c(1,-1,1), lty = c(-1, 1,-1),
       col = c("black", "red", "grey"),
       bty = "n")
}

tempo_simu_plot_fun(dt)

```
    Yes, it still works. In fact, we see that the adjusted births are very close to the observed births when using this number of simulations. (I continue to use an N of 4 million for the rest of this problem).  
    b. Try with a shift function that goes up and down. Are the adjusted counts ever LESS than the observed counts? If so, when?   
```{r echo= FALSE, message=FALSE, warning=FALSE}

x <- rnorm(N, mean = 30, sd = 4)
t <- runif(N, min = min(year.vec), max(year.vec)+1)
dt <- data.table(x, t)

#########################
## shifting the births ##
#########################

# sinusoidal curve
shift.t <- sin((year.vec - 1990)/2.5)


plot(year.vec, shift.t, type = "o",
     main = "Cumulative shifts")



## include shifts as a column
Rt <- approx(x = year.vec, y = shift.t, xout = t)$y
dt[, Rt := approx(x = year.vec, y = shift.t, xout = t)$y]
## calculate shifted times and ages of births
dt[, t.obs := t + Rt]
dt[, x.obs := x + Rt]
## retain only the original time window (for convenience)
dt <- dt[floor(t.obs) %in% year.vec]


##########################################
## observed births counts and mean ages ##
##########################################

out <- dt[, .(Bt = .N,                   ## count the events
              mut = mean(x.obs)),      ## get mean age
          by = .(year = floor(t.obs))] ## by whole years
out <- out[order(year)]

############################################
## change in mean age and adjusted counts ##
############################################

out[, rt.hat := center.diff(mut, end.fill = T)]
out[, Rt.hat := cumsum(rt.hat)]
out[, Bt.adj := Bt / (1 - rt.hat)]


## function version of tabulating and plotting

tempo_simu_plot_fun <- function(dt)
{

    ## requires x.obs and t.obs and
    ## (optionally) t, the original unshifted birth times

##########################################
## observed births counts and mean ages ##
##########################################

out <- dt[, .(Bt = .N,                   ## count the events
              mut = mean(x.obs)),      ## get mean age
          by = .(year = floor(t.obs))] ## by whole years
out <- out[order(year)]

############################################
## change in mean age and adjusted counts ##
############################################

out[, rt.hat := center.diff(mut, end.fill = T)]
out[, Rt.hat := cumsum(rt.hat)]
out[, Bt.adj := Bt / (1 - rt.hat)]


######################
## plot the results ##
######################

par(mfrow = c(2,2))
out[, plot(year, Bt, ylim = c(.8, 1.2) * range(Bt),
           main = "Observed Births")]
out[, plot(year, mut,
           main = "Mean age of birth")]
out[, plot(year, center.diff(mut),
           main = "Change in mean age of birth")]
## observed, adjusted, and original births
Bt.orig.vec <- dt[, table(floor(t))]
out[, plot(year, Bt, ylim = c(.8, 1.5) * range(Bt),
           main = "Observed and Adjusted Births")]
out[, lines(year, Bt.adj, col = "red")]
points(names(Bt.orig.vec), Bt.orig.vec, col = "grey")
legend("top", c("observed", "adjusted", "original"),
       pch = c(1,-1,1), lty = c(-1, 1,-1),
       col = c("black", "red", "grey"),
       bty = "n")
}

tempo_simu_plot_fun(dt)

```
    The adjusted counts are not always less than the observed. Naturally, this only happens when we have spikes on the observed counts that become smoother after the adjusting of the birth counts.  
    c. If the cumulative shift was Rt = a + 0.1*t, what would be a formula for tempo-adjusted counts of births? Sketch the 4 panels without the computer and then check to see if you're right.  
Let $a = -199$, so we get a shift of 0 to about 3 years depending on the time period:  
```{r echo=FALSE, message=FALSE, warning=FALSE}
x <- rnorm(N, mean = 30, sd = 4)
t <- runif(N, min = min(year.vec), max(year.vec)+1)
dt <- data.table(x, t)

#########################
## shifting the births ##
#########################


#linear shift
alpha = -199

shift.t <-  alpha + 0.1*year.vec


plot(year.vec, shift.t, type = "o",
     main = "Cumulative shifts")



## include shifts as a column
Rt <- approx(x = year.vec, y = shift.t, xout = t)$y
dt[, Rt := approx(x = year.vec, y = shift.t, xout = t)$y]
## calculate shifted times and ages of births
dt[, t.obs := t + Rt]
dt[, x.obs := x + Rt]
## retain only the original time window (for convenience)
dt <- dt[floor(t.obs) %in% year.vec]


##########################################
## observed births counts and mean ages ##
##########################################

out <- dt[, .(Bt = .N,                   ## count the events
              mut = mean(x.obs)),      ## get mean age
          by = .(year = floor(t.obs))] ## by whole years
out <- out[order(year)]

############################################
## change in mean age and adjusted counts ##
############################################

out[, rt.hat := center.diff(mut, end.fill = T)]
out[, Rt.hat := cumsum(rt.hat)]
out[, Bt.adj := Bt / (1 - rt.hat)]


## function version of tabulating and plotting

tempo_simu_plot_fun <- function(dt)
{

    ## requires x.obs and t.obs and
    ## (optionally) t, the original unshifted birth times

##########################################
## observed births counts and mean ages ##
##########################################

out <- dt[, .(Bt = .N,                   ## count the events
              mut = mean(x.obs)),      ## get mean age
          by = .(year = floor(t.obs))] ## by whole years
out <- out[order(year)]

############################################
## change in mean age and adjusted counts ##
############################################

out[, rt.hat := center.diff(mut, end.fill = T)]
out[, Rt.hat := cumsum(rt.hat)]
out[, Bt.adj := Bt / (1 - rt.hat)]


######################
## plot the results ##
######################

par(mfrow = c(2,2))
out[, plot(year, Bt, ylim = c(.8, 1.2) * range(Bt),
           main = "Observed Births")]
out[, plot(year, mut,
           main = "Mean age of birth")]
out[, plot(year, center.diff(mut),
           main = "Change in mean age of birth")]
## observed, adjusted, and original births
Bt.orig.vec <- dt[, table(floor(t))]
out[, plot(year, Bt, ylim = c(.8, 1.5) * range(Bt),
           main = "Observed and Adjusted Births")]
out[, lines(year, Bt.adj, col = "red")]
points(names(Bt.orig.vec), Bt.orig.vec, col = "grey")
legend("top", c("observed", "adjusted", "original"),
       pch = c(1,-1,1), lty = c(-1, 1,-1),
       col = c("black", "red", "grey"),
       bty = "n")
}

tempo_simu_plot_fun(dt)
```
2. Calculate the age profile of fertility change predicted by the BongaartsFeeney model by taking time derivatives of the log schedules. You will end up with three terms. Describe each of these in words.  
    $$\begin{aligned}
    f(a,t)&=f_0(a-R(t))[1-R'(t)]q(t)\\
    log(f(a,t))&=log(f_0(a-R(t))) + log(1-R'(t)) + log(q(t))\\
    \frac{\partial log(f(a,t))}{\partial t}&=\frac{\partial log(f_0(a-R(t)))}{\partial t} + \frac{\partial
    log(1-R'(t))}{\partial t} + \frac{\partial log(q(t))}{\partial t}\\
    \frac{\partial log(f(a,t))}{\partial t}&=-R'(t)\frac{f_0'(a-R(t))}{f_0(a-R(t))} -\frac{R''(t)}{1-R'(t)} + \frac{q'(t)}{q(t)}
    \end{aligned}$$
    The first term represents the proportional change in the fertility of the equivalent pre-postponement cohort. In particular, it is divided into (how far someone shifts 'over' relative to ages on the baseline fertility schedule) and an $R'(t)$ term (how much one shifts 'up'). The second term represents the proportional change in the rate of change in years of postponement; it is a tempo-effect. The third term represents the proportional change in quantum.
3. Use simulation based on tempo simu.R to check your answer.  

 

