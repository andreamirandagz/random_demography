---
title: "Homework 2"
author: "Solutions"
date: February 5th, 2020
output:
  pdf_document: default
  html_notebook: default
---

1. True/False: The variance of the population distribution of deaths will
always be larger than that of the baseline. Explain your answer briefly.

True. If each individual has their own hazard schedule proportional to baseline $z$, there will be more variation in the distribution of deaths than if each person had the baseline case. The variation for homogeneous populations comes from to chance only, while the variation for heterogeneous populations comes from chance and group variation in risk. Therefore, the variance of the population distribution of deaths will always be larger than that of the baseline (unless the variance is 0). 

2. Use simulation in R to produce plots of the uniform, gamma, and
U-shaped beta distribution. Describe in a sentence, each, how the
population hazard behaves at older ages. (See frailty simulator.R"
for sample code).

```{r, eval = F, echo = F}
## A simulation of mortality frailty
## (1) get the z's: specify and draw from frailty distribution
## (2) get the ages at death from h0*z
## (3) show pop survival, hazard, and average z.
## (4) summary graphic

#######################
## (1) get the z's:  ##
#######################
## specify and draw from frailty distribution

million = 10^6
N <-  million

## uniform
# w <- .9 ## try smaller if you want
# z <- runif(N, min = 1 - w , max = 1 + w)
## mean(z)
## sd(z)
## hist(z)
## Here's code for some gamma and U-shaped beta
## gamma
my.sd <- .5
 sigma.sq <- my.sd^2
z <- rgamma(N, shape = 1/sigma.sq, scale = sigma.sq)
  # mean(z)
  # sd(z)
  # hist(z)
# beta (U-shaped)
z <- rbeta(N, shape1 = .5, shape2 = .5)
hist(z)
# other choices?

#########################################
## (2) simulate ages at death from h0*z ##
#########################################

## note: we call the continuous ages of death "y"
## but we'll make a table of deaths at age "x" and
## using life table notation call the count "Dx"

## we're going to use the gompertz as our baseline

base.b <- 1/9
base.a <- 10^-4
y <- rgomp(N,
           b = base.b, ## doesn't vary
           a = base.a * z) ## multiplicative fixed frailty
hist(y)

###################################################
## (3) show pop survival, hazard, and average z. ##
###################################################


## first define age at death as floor(y) and then
## make a table of deaths at each age ("Dx")
get.Dx <- function(y)
{
    ## counts number of x in single year age groups
    ## including zeros when there's no one
    ## (note: built-in "table()" won't do this :(
    x <- 0:max(floor(y))
    y.fac <- factor(floor(y), levels = x)
    Dx <- tabulate(y.fac)
    names(Dx) <- x
    return(Dx)
}

Dx <- get.Dx(y)
x <- as.numeric(names(Dx))
## get lx by reverse-survival
lx <- rev(cumsum(rev(Dx)))
## get person-years as average of adjacent lx
lxpn <- c(lx[-1], 0)
Lx <- (lx + lxpn)/2
## get hazards
mx <- Dx/Lx

Tx <- rev(cumsum(rev(Lx)))
ex <- Tx/lx

## (4) summary graphic

lx.base <- N * (1- pgomp(x, b = base.b, a = base.a))
Dx.base <- round(-diff(c(lx.base,0)))
mx.base <- base.a * exp(base.b * (x + .5)) ## x + .5
lxpn.base <- c(lx.base[-1], 0)
Lx.base <- (lx.base + lxpn.base)/2
Tx.base <- rev(cumsum(rev(Lx.base)))
ex.base <- Tx.base/lx.base

par(mfrow = c(3,2))
## frailty
hist(z, main = "frailty distribution")
## deaths
plot(x, Dx, main = "death distribution",
     type = "l", ylim = c(0, max(Dx.base)))
lines(x, Dx.base, lty = 2)
legend("topleft", legend = c("pop", "baseline"),
       lty = c(1, 2), cex = .8,  bty = "n")
## survival curve
plot(x, lx, main = "survival curve",
     type = "l")
lines(x, lx.base, lty = 2)
legend("topright", legend = c("pop", "baseline"),
       lty = c(1, 2), cex = .8, bty = "n")
## hazard curve
plot(x, mx, main = "hazards",
     type = "l", log = "y",
     ylim = range(mx.base, na.rm = T, finite = TRUE))
lines(x, mx.base, lty = 2)
legend("topleft", legend = c("pop", "baseline"),
       lty = c(1, 2), cex = .8, bty = "n")
plot(x, ex, main = "Life Expectancy",
     type = "l")
lines(x, ex.base, lty = 2)
```

```{r, eval = F, echo = F}
hgomp <- function(x, b, a)
{
  a * exp(b * x)
}
pgomp <- function(x,b, a)
{
  Hx <- (a/b) * (exp(b*x) - 1)
  lx <- exp(-Hx)
  1-lx
}
dgomp <- function(x, b, a)
{
  hx <- hgomp(x,b,a)
  lx <- 1-pgomp(x,b,a)
  dx <- hx*lx
  dx
}
idfgomp <- function(u, b, a)
{
  x = (1/b) * log(-log(1-u)*b/a + 1)
  x
}
## idfgomp(u = .5, b = .1, a = .001)
rgomp <- function(N, b, a)
{
  u <- runif(N)
  x <- idfgomp(u, b, a)
  x
}
```

## Gamma Distribution
![](figures/gamma_hazard.png)

## Beta Distribution

![](figures/beta_hazard.png)

## Uniform  Distribution

![](figures/uniform_hazard.png)

* Gamma-distributed frailty begins to increase more slowly after age 60 compared to baseline.
* Beta-distributed frailty begins to increase more slowly after age 60 compared to baseline and eventually stops increasing at age 100.     
* Uniform-distributed frailty begins to increase more slowly after age 60 compared to baseline. Similar to gamma-distributed frailty. 

3. Does the behavior of the uniform at older ages look like a population
with two (proportional) sub-groups? What do you think is driving
this? (This is an open-ended question. You should feel free to use
mathematics, intuition, or any other approach to answer.)

It doesn't look like two proportional subgroups. It looks like the frailty is drawn from a single distribution (but very up to interpretation â€” answers were split). 

4. Does the behavior of the beta at older ages look like the gamma at
older ages? What do you think is driving this? (Also open ended)

The behavior is somewhat similar, as the hazards are increasing more slowly at older ages. However, the beta hazards stops increasing at a certain point. The uniform and the gamma are more similar. For the parameters we used, beta-distributed frailty generates many very-frail or very-robust individuals and fewer medium-frail individuals. Gamma-distributed frailty generates many medium-frail individuals but fewer very-frail or very-robust individuals. 

5. At what age do population hazards start to diverge from the baseline
in the the three models? Is it fair to say that half the cohort has to
have died before unobserved heterogeneity plays a role?

Generally around age 65, but if frailty is beta distributed (with our set of parameters) then we observe a divergence earlier. For the gamma and uniform frailty models roughly half the cohort has to die before unobserved heterogeneity plays a role, but for the beta model we observe divergence in the survival curve much earlier. 

6. Extend the simulation code to include life expectancy at age x. 

(Shown above.)

See above. 

7. Extend the simulation code to include the average frailty of the surviving at age x, z(x). (Note: this requires some more difficulty programming, and I would recommend keeping your N fairly small.)

```{r, eval = F, echo = F}
## Uniform
  w <- .9 ## try smaller if you want
  z <- runif(N, min = 1 - w , max = 1 + w)

# gamma
# my.sd <- .5
#  sigma.sq <- my.sd^2
#z <- rgamma(N, shape = 1/sigma.sq, scale = sigma.sq)

## beta (U-shaped)
 z <- rbeta(N, shape1 = .5, shape2 = .5)
 hist(z)
 # ## other choices?

base.b <- 1/9
base.a <- 10^-4
y <- rgomp(N,
           b = base.b, ## doesn't vary
           a = base.a * z) ## multiplicative fixed frailty
hist(y)


avg_hazard <- tibble(
  age = floor(y),
  z = z
)

avg_hazard_plot <- avg_hazard %>% 
  group_by(age) %>% 
  summarize(z_mean = mean(z), n = n()) %>% 
  mutate(z_bar_num = cumsum(rev(z_mean*n)), z_bar_denom = cumsum(rev(n))) %>% 
  mutate(z_bar = rev(z_bar_num/z_bar_denom) )

avg_hazard_plot %>% 
  ggplot(aes(x = age, y = z_bar)) +
  geom_point() + 
  theme_minimal() + 
  ggtitle("Uniform Hazards Average Frailty")
```
![](figures/uniform_avg_hazard.png)


![](figures/gamma_avg_hazard.png)

![](figures/beta_avg_hazard.png)

8. Extend the simulation code to histograms of frailty of survivors at
different ages. Does the uniform stay uniform? How about the other
distributions?

```{r, eval = F, echo = F}
library(gridExtra)

avg_hazard1 <- avg_hazard %>% 
  filter(age > 0) %>% 
  ggplot() +
  geom_histogram(aes(x = z)) + 
  theme_minimal() + 
  ggtitle("Beta Hazards Frailty")

avg_hazard2 <- avg_hazard %>% 
  filter(age > 25) %>% 
  ggplot() +
  geom_histogram(aes(x = z)) + 
  theme_minimal() + 
  ggtitle("Beta Hazards Frailty (survivors 25+)")

avg_hazard3 <- avg_hazard %>% 
  filter(age > 50) %>% 
  ggplot() +
  geom_histogram(aes(x = z)) + 
  theme_minimal() + 
  ggtitle("Beta Hazards Frailty (survivors 50+)")
  
avg_hazard4 <- avg_hazard%>% 
  filter(age > 75) %>% 
  ggplot() +
  geom_histogram(aes(x = z)) + 
  theme_minimal() + 
  ggtitle("Beta Hazards Frailty (survivors 75+)")

grid.arrange(avg_hazard1, avg_hazard2, avg_hazard3, avg_hazard4, ncol=2)
  
  
  mutate(age_group = case_when(
    age < 25 ~ "(0-25]",
    age < 50 ~"(25, 50]",
    age < 75 ~ "(50, 75]",
    age >= 75 ~"75+"
  )) 

avg_hazard %>% 
  ggplot() +
  geom_histogram(aes(x = z)) + 
  theme_minimal() + 
  ggtitle("Uniform Hazards Average Frailty") + 
  facet_wrap(~age_group, scales = "free")


```


![](figures/uniform_hazards_histogram.png)

![](figures/gamma_hazards_histogram.png)
![](figures/beta_histogram_hazard.png)
The uniform does not remain uniform. This matches our intuition that people with higher frailty will die off first. This leaves an exponentially decreasing distribution of frailty for survivors age 75+. The gamma remains a gamma but the parameters change. The beta, similar to the uniform, does not remain beta. There is an exponentially decreasing distribution of frailty for survivors age 75+. 

9. Use the method of completing the gamma to get the mean of the gamma
distribution. (Hint: I believe there are youtube examples of this).

\begin{equation}
\begin{split}
\mu 
& = \int_0^{\infty} \frac{1}{\Gamma(k) \lambda^k} z^{k - 1} e^{-\frac{z}{\lambda}} \\
& = \frac{\Gamma(k+1) \lambda^{k+1}}{\Gamma(k+1) \lambda^{k+1}} \cdot \int_0^{\infty} \frac{1}{\Gamma(k) \lambda^k} z^{k - 1} e^{-\frac{z}{\lambda}} \\
& = \frac{\Gamma(k+1) \lambda^{k+1}}{\Gamma(k) \lambda^{k}} \cdot \int_0^{\infty} \frac{1}{\Gamma(k+1) \lambda^{k+1}} z^{k - 1} e^{-\frac{z}{\lambda}} \\ 
& = k \lambda \cdot 1 \\
& = k \lambda
\end{split}
\end{equation}









